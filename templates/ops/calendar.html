{% extends "ops/base.html" %}

{% block content %}
<section class="calendar-shell">
  <article class="panel calendar-live-panel">
    <div class="panel-head">
      <h3>Live Outlook Calendar</h3>
      {% if outlook_calendar_open_url %}
      <a class="btn light" href="{{ outlook_calendar_open_url }}" target="_blank" rel="noopener noreferrer">Open In Outlook</a>
      {% endif %}
    </div>
    {% if outlook_calendar_placeholder %}
    <p class="inline-meta">
      Set <code>ASME_OUTLOOK_CALENDAR_EMBED_URL</code> in <code>instance/print_commands.env</code> to display your live calendar.
    </p>
    {% elif outlook_calendar_embed_url %}
    <iframe
      class="calendar-embed"
      src="{{ outlook_calendar_embed_url }}"
      title="Live Outlook Calendar"
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade"
    ></iframe>
    <p class="inline-meta">
      If the embed is blocked by browser privacy settings, use <strong>Open In Outlook</strong>.
    </p>
    {% endif %}
  </article>

  <aside class="panel calendar-book-panel">
    <div class="panel-head">
      <h3>Schedule Meeting</h3>
    </div>
    <p class="inline-meta">Choose room/date/time. Overlapping meetings in the same room are blocked automatically.</p>
    <form method="post" action="/calendar/book" class="form-stack calendar-book-form">
      <input type="hidden" name="next" value="/calendar" />
      <label for="team_name">Team Name</label>
      <input id="team_name" name="team_name" required />

      <label for="requester_email">Requester Email</label>
      <input id="requester_email" name="requester_email" type="email" />

      <label for="room">Room</label>
      <select id="room" name="room" required>
        {% for room in meeting_rooms %}
        <option value="{{ room }}">{{ room }}</option>
        {% endfor %}
      </select>

      <div class="form-grid calendar-time-grid">
        <div>
          <label for="meeting_date">Date</label>
          <input id="meeting_date" name="meeting_date" type="date" value="{{ calendar_default_date }}" min="{{ calendar_default_date }}" required />
        </div>
        <div>
          <label for="start_time">Start</label>
          <input id="start_time" name="start_time" type="time" required />
        </div>
        <div>
          <label for="end_time">End</label>
          <input id="end_time" name="end_time" type="time" required />
        </div>
      </div>

      <label for="notes">Notes (optional)</label>
      <textarea id="notes" name="notes"></textarea>
      <button type="submit" class="btn">Schedule Meeting</button>
    </form>
    <div class="calendar-room-summary">
      <h4>Upcoming Meetings</h4>
      <p class="inline-meta"><strong>{{ meetings_by_room.get("Robotics Room", [])|length }}</strong> Robotics Room</p>
      <p class="inline-meta"><strong>{{ meetings_by_room.get("Fluids Lab", [])|length }}</strong> Fluids Lab</p>
    </div>
  </aside>
</section>

{% if pending_cancellations %}
<section class="panel">
  <div class="panel-head">
    <h3>Pending Cancellation Requests</h3>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Team</th><th>Room</th><th>Date</th><th>Time</th><th>Requested At</th><th>Status</th></tr>
      </thead>
      <tbody>
        {% for meeting in pending_cancellations %}
        <tr>
          <td>{{ meeting.team_name }}</td>
          <td>{{ meeting.room }}</td>
          <td>{{ meeting.meeting_date.isoformat() }}</td>
          <td>{{ meeting.start_time.strftime("%H:%M") }} - {{ meeting.end_time.strftime("%H:%M") }}</td>
          <td>{{ meeting.cancel_requested_at.strftime("%Y-%m-%d %H:%M") if meeting.cancel_requested_at else "" }}</td>
          <td><span class="badge warn">EMAIL CONFIRMATION PENDING</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<section class="panel">
  <div class="panel-head">
    <h3>Room Schedules</h3>
  </div>
  <p class="inline-meta">Bookings are sorted by date/time. Cancel workflow: click cancel, then confirm from the email approval link.</p>
</section>

{% for room in meeting_rooms %}
<section class="panel">
  <div class="panel-head">
    <h3>{{ room }} Schedule</h3>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Date</th><th>Day</th><th>Start</th><th>End</th><th>Team</th><th>Requester</th><th>Notes</th><th>Manage</th></tr>
      </thead>
      <tbody>
        {% for meeting in meetings_by_room.get(room, []) %}
        <tr>
          <td>{{ meeting.meeting_date.isoformat() }}</td>
          <td>{{ meeting.meeting_date.strftime("%A") }}</td>
          <td>{{ meeting.start_time.strftime("%H:%M") }}</td>
          <td>{{ meeting.end_time.strftime("%H:%M") }}</td>
          <td>{{ meeting.team_name }}</td>
          <td>{{ meeting.requester_email or "" }}</td>
          <td>{{ meeting.notes or "" }}</td>
          <td>
            {% if meeting.cancel_request_token %}
            <span class="badge warn">PENDING EMAIL CONFIRMATION</span>
            {% else %}
            <form method="post" action="/calendar/meeting/{{ meeting.id }}/cancel" onsubmit="return confirm('Request cancellation and send confirmation email?');">
              <input type="hidden" name="next" value="/calendar" />
              <button type="submit" class="btn danger">Cancel Request</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not meetings_by_room.get(room, []) %}
        <tr><td colspan="8" class="empty">No upcoming meetings scheduled.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>
{% endfor %}
{% endblock %}
